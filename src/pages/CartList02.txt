import { useEffect, useState } from "react";

import { Button, Card, Col, Container, Row, Image, Table, Form } from "react-bootstrap";
import { Link, useNavigate } from "react-router-dom";

import { API_BASE_URL } from "../config/config";
import axios from "axios";

function App({ user }) {
    const thStyle = { fontSize: '1.2rem' }; //테이블 헤더 스타일

    //보여주고자 하는 '카트 상품' 배열 정보.
    const [cartProducts, setCartProducts] = useState([]);

    //화면에 보여주는 주문 총 금액을 위한 스테이트
    const [orderTotalPrice, setOrderTotalPrice] = useState(0);

    const navigate = useNavigate();

    //사용자의 정보가 바뀔때 화면을 렌더링 해주어야 합니다.
    //user?.id : Optional Chaining(물음표를 적어주면 오류가 발생하지 않고, 'undefined' 를 반환해 줍니다.)
    //즉, '오류화면' 을 보여주지 않고 아무런 일이 없었다는 듯이 동작함.
    useEffect(() => {
        if (user && user.id) {
            fetchCartProducts();
        }
    }, [user]);

    //특정 고객이 장바구니에 담은 '카트 상품' 목록을 조회합니다.
    const fetchCartProducts = async () => {
        try {
            const url = `${API_BASE_URL}/cart/list/${user.id}`;
            const response = await axios.get(url);
            console.log('카트 상품 조회결과');
            console.log(response.data);

            setCartProducts(response.data || []);

        } catch (error) {
            console.log('오류 정보');
            console.log(error);
            alert(`'카트 상품' 정보가 존재하지 않아서 '상품 목록' 페이지로 이동합니다.`);
            navigate('/product/list');
        }
    };

    //'전체 선택' 체크 박스를 'Toggle' 했습니다.
    const toggleAllCheckBox = (isAllCheck) => {
        //isAllCheck : 전체 선택 체크 박스의 'boolean 값'
        setCartProducts((previous) => {
            /* 모든 객체(카트 상품)들의 나머지 속성은 보존하고, 체크 상태(checked)로 만들고,
               --> '전체 선택' 체크 상태와 동일하게 설정. */
            const updatedProducts = previous.map((product) => ({ ...product, checked: isAllCheck }));

            //'비동기적 렌더링 문제' 로 수정된 'updatedProducts 항목' 을 '매개 변수' 로 넘겨야 정상적으로 동작합니다.
            refreshOrderTotalPrice(updatedProducts);

            return updatedProducts;
        });
    };

    //체크 박스의 상태가 'Toggle' 될 때마다 전체 요금을 재 계산하는 함수입니다.
    const refreshOrderTotalPrice = (products) => {
        let total = 0; //총 금액 변수

        products.forEach((bean) => {
            if (bean.checked) { //선택된 체크 박스
                total += bean.price * bean.quantity; //총 금액 누적
            }
        });

        setOrderTotalPrice(total); //State 업데이트
    };


    return (
        <Container className="mt-4">
            <h2 className="mb-4">
                {/* 'xxrem' 은 '주위 글꼴' 의 'xx 배를 의미' 합니다. */}
                <span style={{ color: 'blue', fontSize: '2rem' }}>{user?.name}</span>
                <span style={{ fontSize: '1.3rem' }}>님의 장바구니</span>
            </h2>
            <Table striped bordered>
                <thead>
                    <tr>
                        <th style={thStyle}>
                            {/* '전체 선택' 체크 박스의 체크 상태(boolean)를 'toggleAllCheckBox 함수' 에 전달. */}
                            <Form.Check
                                type="checkbox"
                                label="전체 선택"
                                onChange={(event) => toggleAllCheckBox(event.target.checked)} />
                        </th>
                        <th style={thStyle}>상품 정보</th>
                        <th style={thStyle}>수량</th>
                        <th style={thStyle}>금액</th>
                        <th style={thStyle}>삭제</th>
                    </tr>
                </thead>
                <tbody>
                    {cartProducts.length > 0 ? (
                        cartProducts.map((product) => (
                            <tr key={product.cartProductId}>
                                <td className="text-center align-middle">
                                    <Form.Check
                                        type="checkbox"
                                        checked={product.checked}
                                        onChange={``}
                                    />
                                </td>
                                <td className="text-center align-middle">
                                    <Row> {/* 좌측 4칸은 이미지 영역, 우측 8칸은 상품 이름 영역 */}
                                        <Col xs={4}>
                                            <Image
                                                src={`${API_BASE_URL}/images/${product.image}`}
                                                thumbnail
                                                alt={product.name}
                                                width={`80`}
                                                height={`80`}
                                            />
                                        </Col>
                                        <Col xs={8} className="d-flex align-items-center">
                                            {product.name}
                                        </Col>
                                    </Row>
                                </td>
                                <td className="text-center align-middle">
                                    <Form.Control
                                        type="number"
                                        min={1}
                                        value={product.quantity}
                                        onChange={``}
                                        style={{ width: '80px', margin: '0 auto' }}
                                    />
                                </td>
                                <td className="text-center align-middle">
                                    {(product.price * product.quantity).toLocaleString()} 원
                                </td>
                                <td className="text-center align-middle">
                                    <Button variant="danger" size="sm" onClick={``}>
                                        삭제
                                    </Button>
                                </td>
                            </tr>
                        ))
                    ) : (
                        <tr><td>장바구니가 비어있습니다.</td></tr>
                    )}
                </tbody>
            </Table >
            {/* 좌측 정렬(text-start), 가운데 정렬(text-center), 우측 정렬(text-end)을 의미합니다. */}
            < h3 className="text-end mt-3" > 총 주문 금액: {orderTotalPrice.toLocaleString()}원</h3 >
            <div className="text-end">
                <Button variant="primary" size="lg" onClick={``}>
                    주문하기
                </Button>
            </div >
        </Container >
    );
}

export default App;